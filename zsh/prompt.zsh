gn=${fg[green]}
yw=${fg[yellow]}
be=${fg[blue]}
cn=${fg[cyan]}
ma=${fg[magenta]}
rd=${fg[red]}
gy=${fg[gray]}
rc=$reset_color

colors=(
  $'%{\e[38;5;000m%}' $'%{\e[38;5;001m%}' $'%{\e[38;5;002m%}' $'%{\e[38;5;003m%}'
  $'%{\e[38;5;004m%}' $'%{\e[38;5;005m%}' $'%{\e[38;5;006m%}' $'%{\e[38;5;007m%}'
  $'%{\e[38;5;008m%}' $'%{\e[38;5;009m%}' $'%{\e[38;5;010m%}' $'%{\e[38;5;011m%}'
  $'%{\e[38;5;012m%}' $'%{\e[38;5;013m%}' $'%{\e[38;5;014m%}' $'%{\e[38;5;015m%}'
  $'%{\e[38;5;016m%}' $'%{\e[38;5;017m%}' $'%{\e[38;5;018m%}' $'%{\e[38;5;019m%}'
  $'%{\e[38;5;020m%}' $'%{\e[38;5;021m%}' $'%{\e[38;5;022m%}' $'%{\e[38;5;023m%}'
  $'%{\e[38;5;024m%}' $'%{\e[38;5;025m%}' $'%{\e[38;5;026m%}' $'%{\e[38;5;027m%}'
  $'%{\e[38;5;028m%}' $'%{\e[38;5;029m%}' $'%{\e[38;5;030m%}' $'%{\e[38;5;031m%}'
  $'%{\e[38;5;032m%}' $'%{\e[38;5;033m%}' $'%{\e[38;5;034m%}' $'%{\e[38;5;035m%}'
  $'%{\e[38;5;036m%}' $'%{\e[38;5;037m%}' $'%{\e[38;5;038m%}' $'%{\e[38;5;039m%}'
  $'%{\e[38;5;040m%}' $'%{\e[38;5;041m%}' $'%{\e[38;5;042m%}' $'%{\e[38;5;043m%}'
  $'%{\e[38;5;044m%}' $'%{\e[38;5;045m%}' $'%{\e[38;5;046m%}' $'%{\e[38;5;047m%}'
  $'%{\e[38;5;048m%}' $'%{\e[38;5;049m%}' $'%{\e[38;5;050m%}' $'%{\e[38;5;051m%}'
  $'%{\e[38;5;052m%}' $'%{\e[38;5;053m%}' $'%{\e[38;5;054m%}' $'%{\e[38;5;055m%}'
  $'%{\e[38;5;056m%}' $'%{\e[38;5;057m%}' $'%{\e[38;5;058m%}' $'%{\e[38;5;059m%}'
  $'%{\e[38;5;060m%}' $'%{\e[38;5;061m%}' $'%{\e[38;5;062m%}' $'%{\e[38;5;063m%}'
  $'%{\e[38;5;064m%}' $'%{\e[38;5;065m%}' $'%{\e[38;5;066m%}' $'%{\e[38;5;067m%}'
  $'%{\e[38;5;068m%}' $'%{\e[38;5;069m%}' $'%{\e[38;5;070m%}' $'%{\e[38;5;071m%}'
  $'%{\e[38;5;072m%}' $'%{\e[38;5;073m%}' $'%{\e[38;5;074m%}' $'%{\e[38;5;075m%}'
  $'%{\e[38;5;076m%}' $'%{\e[38;5;077m%}' $'%{\e[38;5;078m%}' $'%{\e[38;5;079m%}'
  $'%{\e[38;5;080m%}' $'%{\e[38;5;081m%}' $'%{\e[38;5;082m%}' $'%{\e[38;5;083m%}'
  $'%{\e[38;5;084m%}' $'%{\e[38;5;085m%}' $'%{\e[38;5;086m%}' $'%{\e[38;5;087m%}'
  $'%{\e[38;5;088m%}' $'%{\e[38;5;089m%}' $'%{\e[38;5;090m%}' $'%{\e[38;5;091m%}'
  $'%{\e[38;5;092m%}' $'%{\e[38;5;093m%}' $'%{\e[38;5;094m%}' $'%{\e[38;5;095m%}'
  $'%{\e[38;5;096m%}' $'%{\e[38;5;097m%}' $'%{\e[38;5;098m%}' $'%{\e[38;5;099m%}'
  $'%{\e[38;5;100m%}' $'%{\e[38;5;101m%}' $'%{\e[38;5;102m%}' $'%{\e[38;5;103m%}'
  $'%{\e[38;5;104m%}' $'%{\e[38;5;105m%}' $'%{\e[38;5;106m%}' $'%{\e[38;5;107m%}'
  $'%{\e[38;5;108m%}' $'%{\e[38;5;109m%}' $'%{\e[38;5;110m%}' $'%{\e[38;5;111m%}'
  $'%{\e[38;5;112m%}' $'%{\e[38;5;113m%}' $'%{\e[38;5;114m%}' $'%{\e[38;5;115m%}'
  $'%{\e[38;5;116m%}' $'%{\e[38;5;117m%}' $'%{\e[38;5;118m%}' $'%{\e[38;5;119m%}'
  $'%{\e[38;5;120m%}' $'%{\e[38;5;121m%}' $'%{\e[38;5;122m%}' $'%{\e[38;5;123m%}'
  $'%{\e[38;5;124m%}' $'%{\e[38;5;125m%}' $'%{\e[38;5;126m%}' $'%{\e[38;5;127m%}'
  $'%{\e[38;5;128m%}' $'%{\e[38;5;129m%}' $'%{\e[38;5;130m%}' $'%{\e[38;5;131m%}'
  $'%{\e[38;5;132m%}' $'%{\e[38;5;133m%}' $'%{\e[38;5;134m%}' $'%{\e[38;5;135m%}'
  $'%{\e[38;5;136m%}' $'%{\e[38;5;137m%}' $'%{\e[38;5;138m%}' $'%{\e[38;5;139m%}'
  $'%{\e[38;5;140m%}' $'%{\e[38;5;141m%}' $'%{\e[38;5;142m%}' $'%{\e[38;5;143m%}'
  $'%{\e[38;5;144m%}' $'%{\e[38;5;145m%}' $'%{\e[38;5;146m%}' $'%{\e[38;5;147m%}'
  $'%{\e[38;5;148m%}' $'%{\e[38;5;149m%}' $'%{\e[38;5;150m%}' $'%{\e[38;5;151m%}'
  $'%{\e[38;5;152m%}' $'%{\e[38;5;153m%}' $'%{\e[38;5;154m%}' $'%{\e[38;5;155m%}'
  $'%{\e[38;5;156m%}' $'%{\e[38;5;157m%}' $'%{\e[38;5;158m%}' $'%{\e[38;5;159m%}'
  $'%{\e[38;5;160m%}' $'%{\e[38;5;161m%}' $'%{\e[38;5;162m%}' $'%{\e[38;5;163m%}'
  $'%{\e[38;5;164m%}' $'%{\e[38;5;165m%}' $'%{\e[38;5;166m%}' $'%{\e[38;5;167m%}'
  $'%{\e[38;5;168m%}' $'%{\e[38;5;169m%}' $'%{\e[38;5;170m%}' $'%{\e[38;5;171m%}'
  $'%{\e[38;5;172m%}' $'%{\e[38;5;173m%}' $'%{\e[38;5;174m%}' $'%{\e[38;5;175m%}'
  $'%{\e[38;5;176m%}' $'%{\e[38;5;177m%}' $'%{\e[38;5;178m%}' $'%{\e[38;5;179m%}'
  $'%{\e[38;5;180m%}' $'%{\e[38;5;181m%}' $'%{\e[38;5;182m%}' $'%{\e[38;5;183m%}'
  $'%{\e[38;5;184m%}' $'%{\e[38;5;185m%}' $'%{\e[38;5;186m%}' $'%{\e[38;5;187m%}'
  $'%{\e[38;5;188m%}' $'%{\e[38;5;189m%}' $'%{\e[38;5;190m%}' $'%{\e[38;5;191m%}'
  $'%{\e[38;5;192m%}' $'%{\e[38;5;193m%}' $'%{\e[38;5;194m%}' $'%{\e[38;5;195m%}'
  $'%{\e[38;5;196m%}' $'%{\e[38;5;197m%}' $'%{\e[38;5;198m%}' $'%{\e[38;5;199m%}'
  $'%{\e[38;5;200m%}' $'%{\e[38;5;201m%}' $'%{\e[38;5;202m%}' $'%{\e[38;5;203m%}'
  $'%{\e[38;5;204m%}' $'%{\e[38;5;205m%}' $'%{\e[38;5;206m%}' $'%{\e[38;5;207m%}'
  $'%{\e[38;5;208m%}' $'%{\e[38;5;209m%}' $'%{\e[38;5;210m%}' $'%{\e[38;5;211m%}'
  $'%{\e[38;5;212m%}' $'%{\e[38;5;213m%}' $'%{\e[38;5;214m%}' $'%{\e[38;5;215m%}'
  $'%{\e[38;5;216m%}' $'%{\e[38;5;217m%}' $'%{\e[38;5;218m%}' $'%{\e[38;5;219m%}'
  $'%{\e[38;5;220m%}' $'%{\e[38;5;221m%}' $'%{\e[38;5;222m%}' $'%{\e[38;5;223m%}'
  $'%{\e[38;5;224m%}' $'%{\e[38;5;225m%}' $'%{\e[38;5;226m%}' $'%{\e[38;5;227m%}'
  $'%{\e[38;5;228m%}' $'%{\e[38;5;229m%}' $'%{\e[38;5;230m%}'
)

has ip && export IP=`ip | awk -F ' ' 'NR==1 {print $2}'`

c_ip=$colors[$((`echo "$IP" | sum | cut -f1 -d' '`%${#colors}))+1]$IP
c_user=$colors[$((`expr $(echo $USER | sum | awk -F ' ' '{print $1}') + $(echo $IP | sum | awk -F ' ' '{print $1}')`%${#colors}))+1]$USER
c_host=$colors[$((`echo "$HOST" | sum | cut -f1 -d' '`%${#colors}))+1]$HOST
role='%(!.#.$)'

prompt_bar_left_user='$c_user'
prompt_bar_left_host='$c_host'
prompt_bar_left_branch='`current_branch`'
prompt_bar_left_status="%{%B%(?.%K{blue}%F{white}.%K{red}%F{white})%} %? %{%f%b%}"
prompt_bar_left_date='<%{%B%}%D{%H:%M}%{%b%}>'
# prompt_bar_left_path="%{%B%F{red}%}%d%{%f%k%b%}"
prompt_bar_left_path="%{%B%F{yellow}%} %3~ %{%f%k%b%}"
prompt_bar_left_deco='%{%B%F{magenta}%}'
prompt_bar_left="${prompt_bar_left_status}${prompt_bar_left_branch} ${prompt_bar_left_host}${prompt_bar_left_path}${prompt_bar_left_deco}"
prompt_left='%{%B%F{magenta}%}$role->%{%f%b%}'

count_prompt_characters()
{
  print -n -P -- "$1" | sed -e $'s/\e\[[0-9;]*m//g' | wc -m | sed -e 's/ //g'
}

update_prompt()
{
  local bar_left_length=$(count_prompt_characters "$prompt_bar_left")
  local bar_rest_length=$[COLUMNS - bar_left_length]
  local bar_left="$prompt_bar_left"
  local bar_right_without_path="${prompt_bar_right:s/%d//}"
  local bar_right_without_path_length=$(count_prompt_characters "$bar_right_without_path")
  local max_path_length=$[bar_rest_length - bar_right_without_path_length]
  bar_right=${prompt_bar_right:s/%d/%(C,%${max_path_length}<...<%d%<<,)/}
  local separator="${(l:${bar_rest_length}::_:)}%{%k%f%b%}"
  bar_right="%${bar_rest_length}<<${separator}${bar_right}%<<"
  PROMPT="${bar_left}${bar_right}"$'\n'"${prompt_left}"
  RPROMPT="$c_user:$c_ip"
  case "$TERM_PROGRAM" in
    Apple_Terminal)
      RPROMPT="${RPROMPT}-"
      ;;
  esac
}
precmd_functions=($precmd_functions update_prompt)

current_branch()
{
  if [[ "$PWD" = ${DOTFILES}'/\.git(/.*)?$' ]]; then
    echo "%{%B${fg[black]}%}no git%{${reset_color}%}%b"
    return
  fi
  name=$(basename "`git symbolic-ref HEAD 2> /dev/null`")
  if [[ -z $name ]]; then
    echo "%{%B${fg[black]}%} branch %{${reset_color}%}%b"
    return
  fi
  st=`git status 2> /dev/null`
  if [[ -n `echo "$st" | grep "^nothing to"` ]]; then
    color=${bg[blue]}${fg[green]}
  elif [[ -n `echo "$st" | grep "^nothing added"` ]]; then
    color=${bg[red]}${fg[blue]}
  elif [[ -n `echo "$st" | grep "^# Untracked"` ]]; then
    color=${bg[red]}${fg_bold[white]}
  else
    color=${bg[red]}${fg_bold[white]}
  fi
  # %{...%} は囲まれた文字列がエスケープシーケンスであることを明示する
  # これをしないと右プロンプトの位置がずれる
  echo "%{$color%}%{%B%} $name %{%b%}%{$reset_color%}"
}
